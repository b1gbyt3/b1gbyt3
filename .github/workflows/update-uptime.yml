name: Update Profile Stats in README

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update_readme:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests python-dateutil

      - name: Update Profile Stats
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SYSTEM_START_TIME: ${{ secrets.SYSTEM_START_TIME }}
          GITHUB_USERNAME: ${{ github.repository_owner }}
        run: |
          python - <<EOF
          import os
          import sys
          import re
          import json
          from datetime import date, datetime
          from dateutil.relativedelta import relativedelta
          import requests

          github_token = os.environ.get('GITHUB_TOKEN')
          start_time_str = os.environ.get('SYSTEM_START_TIME')
          username = os.environ.get('GITHUB_USERNAME')
          readme_path = 'README.md'
          graphql_url = 'https://api.github.com/graphql'

          if not github_token:
              print("ERROR: GITHUB_TOKEN is not set.", file=sys.stderr)
              sys.exit(1)

          if not start_time_str:
              print("ERROR: SYSTEM_START_TIME secret is not set or is empty.", file=sys.stderr)
              sys.exit(1)

          if not username:
              print("ERROR: Could not determine GITHUB_USERNAME.", file=sys.stderr)
              sys.exit(1)

          try:
              start_date = date.fromisoformat(start_time_str)
          except ValueError:
              print(f"ERROR: SYSTEM_START_TIME '{start_time_str}' is not a valid YYYY-MM-DD date.", file=sys.stderr)
              sys.exit(1)

          current_date = date.today()
          delta = relativedelta(current_date, start_date)

          years = max(0, delta.years)
          months = max(0, delta.months)
          days = max(0, delta.days)

          uptime_parts = []
          if years:
              uptime_parts.append(f"{years} {'years' if years != 1 else 'year'}")
          if months:
              uptime_parts.append(f"{months} {'months' if months != 1 else 'month'}")
          if days or not uptime_parts:
              uptime_parts.append(f"{days} {'days' if days != 1 else 'day'}")

          uptime_string = " ".join(uptime_parts)
          print(f"Calculated Uptime: {uptime_string}")

          def run_graphql_query(query, variables):
              headers = {'Authorization': f'bearer {github_token}'}
              response = None
              try:
                  response = requests.post(graphql_url, json={'query': query, 'variables': variables}, headers=headers)
                  response.raise_for_status()
                  return response.json()
              except requests.exceptions.RequestException as e:
                  print(f"ERROR during GraphQL request: {e}", file=sys.stderr)
                  if response is not None:
                      print(f"Response status: {response.status_code}", file=sys.stderr)
                      try:
                          print(f"Response body: {response.json()}", file=sys.stderr)
                      except json.JSONDecodeError:
                          print(f"Response body: {response.text}", file=sys.stderr)
                  return None
              except Exception as e:
                   print(f"ERROR processing GraphQL request: {e}", file=sys.stderr)
                   return None

          personal_repos = 0
          contributions = 0
          all_repo_nodes = []
          has_next_page = True
          cursor = None

          repo_query = """
          query GetUserRepos($login: String!, $cursor: String, $ownerAffiliations: [RepositoryAffiliation!]) {
            user(login: $login) {
              repositories(first: 100, after: $cursor, ownerAffiliations: $ownerAffiliations, isFork: null) {
                nodes {
                  name
                  isFork
                }
                pageInfo {
                  endCursor
                  hasNextPage
                }
              }
            }
          }
          """

          print("Fetching repository stats using GraphQL...")
          while has_next_page:
              variables = {
                  'login': username,
                  'cursor': cursor,
                  'ownerAffiliations': ['OWNER']
              }
              result = run_graphql_query(repo_query, variables)

              if result is None:
                  print("ERROR: GraphQL query function returned None. Aborting repo count.", file=sys.stderr)
                  personal_repos = 0
                  contributions = 0
                  break

              if 'errors' in result:
                  print(f"ERROR: GraphQL query failed. Result: {result}", file=sys.stderr)
                  personal_repos = 0
                  contributions = 0
                  break

              data = result.get('data')
              if not data:
                  print(f"ERROR: 'data' key not found or is empty in GraphQL response. Result: {result}", file=sys.stderr)
                  personal_repos = 0
                  contributions = 0
                  break

              user_data = data.get('user')
              if not user_data:
                   print(f"ERROR: 'user' key not found or is empty in GraphQL data. Result: {result}", file=sys.stderr)
                   personal_repos = 0
                   contributions = 0
                   break

              repositories = user_data.get('repositories')
              if not repositories:
                  print(f"Warning: 'repositories' key not found or is empty in user data. Assuming no repositories.", file=sys.stderr)
                  has_next_page = False
                  break

              nodes = repositories.get('nodes')
              page_info = repositories.get('pageInfo', {})

              if nodes is not None:
                  all_repo_nodes.extend(nodes)
              else:
                  print("Warning: 'nodes' key is null or missing within repositories.", file=sys.stderr)

              cursor = page_info.get('endCursor')
              has_next_page = page_info.get('hasNextPage', False)

              if has_next_page and cursor is None:
                  print("ERROR: hasNextPage is true but endCursor is null. Stopping pagination to prevent infinite loop.", file=sys.stderr)
                  has_next_page = False

          if all_repo_nodes:
              for repo in all_repo_nodes:
                  if repo and isinstance(repo, dict):
                      if repo.get('isFork', False):
                          contributions += 1
                      else:
                          personal_repos += 1
                  elif repo is not None:
                      print(f"Warning: Encountered non-dictionary item in repository nodes: {repo}", file=sys.stderr)
              print(f"Fetched Repositories: {personal_repos} (personal), {contributions} (contributions/forks)")
          else:
               print("No repository data processed.")


          try:
              with open(readme_path, 'r', encoding='utf-8') as file:
                  readme_content = file.read()

              readme_content = re.sub(
                  r'(- \*\*⏳ Uptime:\*\*\s*).*?(?=<br>|$)',
                  f'\\1{uptime_string}<br>',
                  readme_content,
                  count=1,
                  flags=re.IGNORECASE
              )

              repo_string = f"{personal_repos} (personal), {contributions} (contributions/forks)"
              readme_content = re.sub(
                  r'(- \*\*📂 Repositories:\*\*\s*).*?(?=<br>|$)',
                  f'\\1{repo_string}<br>',
                  readme_content,
                  count=1,
                  flags=re.IGNORECASE
              )

              with open(readme_path, 'w', encoding='utf-8') as file:
                  file.write(readme_content)

              print(f"{readme_path} updated successfully.")

          except FileNotFoundError:
              print(f"ERROR: {readme_path} not found.", file=sys.stderr)
              sys.exit(1)
          except Exception as e:
              print(f"Error updating {readme_path}: {e}", file=sys.stderr)
              sys.exit(1)
          EOF

      - name: Commit and Push Changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md
          if git diff --staged --quiet; then
            echo "No changes to commit in README.md."
          else
            git commit -m "[update] profile stats"
            git push
            echo "Changes committed and pushed successfully."
          fi
